{% extends 'base.html' %}

{% block title %}Франшиза — бот #{{ bot.id }}{% endblock %}

{% block content %}
<div>
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <div class="page-pretitle">
          <a href="{{ url_for('franchise_page') }}" class="link-secondary"><i class="ti ti-chevron-left"></i> Назад</a>
        </div>
        <h2 class="page-title">Бот франшизы #{{ bot.id }}</h2>
        <div class="text-secondary">
          {% if bot.username %}@{{ bot.username }}{% else %}без_username{% endif %} · telegram_bot_user_id={{ bot.telegram_bot_user_id }} · owner={{ bot.owner_telegram_id }}
        </div>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <form method="post" action="{{ url_for('franchise_toggle_bot_route', bot_id=bot.id) }}" class="d-inline-block">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          {% if bot.is_active %}
            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Отключить бота #{{ bot.id }}?')"><i class="ti ti-power"></i> Отключить</button>
          {% else %}
            <button type="submit" class="btn btn-outline-success"><i class="ti ti-power"></i> Включить</button>
          {% endif %}
        </form>
      </div>
    </div>
  </div>

  <div class="row row-deck row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="subheader">Пользователей</div>
          <div class="h1 mb-0">{{ stats.total_users }}</div>
          <div class="text-secondary">Сообщений: {{ stats.total_messages }}</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="subheader">Оплачено картой</div>
          <div class="h1 mb-0">{{ '%.2f'|format(stats.gross_paid_card) }} ₽</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="subheader">Комиссия</div>
          <div class="h1 mb-0">{{ '%.2f'|format(stats.commission_total) }} ₽</div>
          <div class="text-secondary">Запрошено: {{ '%.2f'|format(stats.requested_withdraw) }} ₽</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="subheader">Доступно</div>
          <div class="h1 mb-0">{{ '%.2f'|format(stats.available) }} ₽</div>
          <div class="text-secondary">Pending: {{ stats.pending_withdraw_count }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">Заявки на вывод</h3>
    </div>
    <div class="table-responsive">
      <table class="table table-vcenter card-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Сумма</th>
            <th>Статус</th>
            <th>Комментарий</th>
            <th>Банк</th>
            <th>Реквизиты</th>
            <th>Создано</th>
            <th class="w-25">Управление</th>
          </tr>
        </thead>
        <tbody>
          {% for r in withdraw_requests %}
          <tr>
            <td class="text-secondary">{{ r.id }}</td>
            <td><strong>{{ '%.2f'|format(r.amount_rub) }} ₽</strong></td>
            <td>
              {% if r.status == 'paid' %}
                <span class="badge bg-green-lt">paid</span>
              {% elif r.status == 'approved' %}
                <span class="badge bg-azure-lt">approved</span>
              {% elif r.status == 'rejected' %}
                <span class="badge bg-red-lt">rejected</span>
              {% else %}
                <span class="badge bg-yellow-lt">pending</span>
              {% endif %}
            </td>
            <td class="text-secondary">{{ r.comment or '' }}</td>
            <td class="text-secondary">{{ r.bank or '' }}</td>
            <td class="text-secondary">{% if r.requisite_value %}{{ r.requisite_type or '' }}: {{ r.requisite_value }}{% else %}{% endif %}</td>
            <td class="text-secondary">{{ r.created_at }}</td>
            <td>
              <form method="post" action="{{ url_for('franchise_withdraw_status_route', req_id=r.id) }}" class="d-flex gap-2 align-items-center">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="bot_id" value="{{ bot.id }}" />
                <select class="form-select form-select-sm" name="status" style="min-width: 160px;">
                  <option value="pending" {% if r.status == 'pending' %}selected{% endif %}>pending</option>
                  <option value="approved" {% if r.status == 'approved' %}selected{% endif %}>approved</option>
                  <option value="paid" {% if r.status == 'paid' %}selected{% endif %}>paid</option>
                  <option value="rejected" {% if r.status == 'rejected' %}selected{% endif %}>rejected</option>
                </select>
                <button type="submit" class="btn btn-outline-primary btn-sm">Сохранить</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if withdraw_requests|length == 0 %}
          <tr><td colspan="8" class="text-center text-secondary p-4">Заявок нет.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="row row-deck row-cards">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header"><h3 class="card-title">Последние начисления</h3></div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table">
            <thead>
              <tr>
                <th>Когда</th>
                <th>Payment</th>
                <th>User</th>
                <th>Сумма</th>
                <th>Комиссия</th>
              </tr>
            </thead>
            <tbody>
              {% for c in commissions %}
              <tr>
                <td class="text-secondary">{{ c.created_at }}</td>
                <td class="text-secondary" style="max-width: 160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ c.payment_id }}</td>
                <td class="text-secondary">{{ c.user_id }}</td>
                <td>{{ '%.2f'|format(c.amount_rub) }} ₽</td>
                <td><strong>{{ '%.2f'|format(c.commission_rub) }} ₽</strong> <span class="text-secondary">({{ c.commission_percent }}%)</span></td>
              </tr>
              {% endfor %}
              {% if commissions|length == 0 %}
              <tr><td colspan="5" class="text-center text-secondary p-4">Начислений нет.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header"><h3 class="card-title">Активность пользователей</h3></div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table">
            <thead>
              <tr>
                <th>User</th>
                <th>First</th>
                <th>Last</th>
                <th>Msgs</th>
              </tr>
            </thead>
            <tbody>
              {% for a in activity %}
              <tr>
                <td class="text-secondary">{{ a.user_id }}</td>
                <td class="text-secondary">{{ a.first_seen }}</td>
                <td class="text-secondary">{{ a.last_seen }}</td>
                <td><strong>{{ a.messages_count }}</strong></td>
              </tr>
              {% endfor %}
              {% if activity|length == 0 %}
              <tr><td colspan="4" class="text-center text-secondary p-4">Данных нет.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
