# üîë –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–∏—Å—Ç–µ–º–µ VPN-–∫–ª—é—á–µ–π

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ö—Ä–∞–Ω–µ–Ω–∏—è-–∫–ª—é—á–µ–π)
- [–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –∫–ª—é—á–∞](#–ø—Ä–æ—Ü–µ—Å—Å-–ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è-–∫–ª—é—á–∞)
- [–°–≤—è–∑—å –∫–ª—é—á–µ–π —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏](#—Å–≤—è–∑—å-–∫–ª—é—á–µ–π-—Å-—Ç–∞—Ä–∏—Ñ–∞–º–∏)
- [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–ª—é—á–∞](#–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª-–∫–ª—é—á–∞)
- [API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏](#api-–¥–ª—è-—Ä–∞–±–æ—Ç—ã-—Å-–∫–ª—é—á–∞–º–∏)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ VPN-–∫–ª—é—á–µ–π ‚Äî —ç—Ç–æ —è–¥—Ä–æ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä–æ–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ–º, —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞ –∫ VPN-—Å–µ—Ä–≤–µ—Ä–∞–º. –ö–∞–∂–¥—ã–π –∫–ª—é—á –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é Telegram –∏ —Ö–æ—Å—Ç—É VPN.

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- **Remnawave API** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ –Ω–∞ VPN-—Ö–æ—Å—Ç–∞—Ö
- **Payment System** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π
- **Bot Handlers** ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π

### –¢–∞–±–ª–∏—Ü–∞ `vpn_keys` –≤ SQLite

```sql
CREATE TABLE IF NOT EXISTS vpn_keys (
    key_id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    user_id INTEGER NOT NULL,
    
    -- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ö–æ—Å—Ç—É –∏ —Ñ—Ä–∞–Ω—à–∏–∑–µ
    host_name TEXT,
    squad_uuid TEXT,
    
    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∫–ª—é—á–∞
    remnawave_user_uuid TEXT,      -- UUID –∫–ª–∏–µ–Ω—Ç–∞ –≤ Remnawave
    short_uuid TEXT,                -- –ö–æ—Ä–æ—Ç–∫–∏–π UUID
    email TEXT UNIQUE,              -- Email –∫–ª—é—á–∞ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
    key_email TEXT UNIQUE,          -- –î—É–±–ª–∏–∫–∞—Ç email –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    
    -- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    subscription_url TEXT,          -- vless:// URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    
    -- –°—Ä–æ–∫–∏ –∏ –ª–∏–º–∏—Ç—ã
    expire_at TIMESTAMP,            -- –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫–ª—é—á–∞
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- –õ–∏–º–∏—Ç—ã —Ç—Ä–∞—Ñ–∏–∫–∞
    traffic_limit_bytes INTEGER,    -- –õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ –±–∞–π—Ç–∞—Ö
    traffic_limit_strategy TEXT DEFAULT 'NO_RESET',  -- –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–±—Ä–æ—Å–∞ (NO_RESET/MONTHLY)
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    tag TEXT,                       -- –¢–µ–≥–∏: trial, paid, user_gift
    description TEXT,               -- JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–∞—Ä–∏—Ñ–µ
    
    -- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    missing_from_server_at TIMESTAMP  -- –í—Ä–µ–º—è –∫–æ–≥–¥–∞ –∫–ª—é—á –ø—Ä–æ–ø–∞–ª —Å —Å–µ—Ä–≤–µ—Ä–∞
)
```

### –ü–æ–ª—è description (JSON)

–í –ø–æ–ª–µ `description` —Ö—Ä–∞–Ω–∏—Ç—Å—è JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–∞—Ä–∏—Ñ–µ –∏ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –∫–ª—é—á–∞:

```json
{
    "v": 1,
    "source": "purchase",           // purchase | extend | trial | gift
    "is_trial": false,
    "plan_id": 3,                   // ID —Ç–∞—Ä–∏—Ñ–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã plans
    "plan_name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç",        // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
    "months": 1,                    // –°—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö
    "duration_days": 30,            // –°—Ä–æ–∫ –≤ –¥–Ω—è—Ö
    "tariff_label": "30 –¥–Ω–µ–π",     // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –º–µ—Ç–∫–∞
    "note": "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
}
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–ª—é—á–∞
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–∏—Ñ–µ –¥–∞–∂–µ –µ—Å–ª–∏ –ø–ª–∞–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
- –•—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫

---

## –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –∫–ª—é—á–∞

### 1. –í—ã–±–æ—Ä —Ö–æ—Å—Ç–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç VPN-—Ö–æ—Å—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö:

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤
hosts = get_all_hosts()
active_hosts = [h for h in hosts if h.get('is_active')]
```

**–§–∞–π–ª:** [src/shop_bot/bot/handlers.py](src/shop_bot/bot/handlers.py#L1066-L1089)

### 2. –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞

–ò–∑ —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞:

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –¥–ª—è —Ö–æ—Å—Ç–∞
plans = get_plans_for_host(host_name)
active_plans = [p for p in plans if p.get('is_active')]
```

**–§–∞–π–ª:** [src/shop_bot/bot/handlers.py](src/shop_bot/bot/handlers.py#L1095-L1140)

**–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:** [src/shop_bot/bot/keyboards.py](src/shop_bot/bot/keyboards.py#L940-L970)

### 3. –í–≤–æ–¥ email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `payment_email_prompt_enabled`:

```python
email_prompt_enabled = (get_setting("payment_email_prompt_enabled") or "false").strip().lower() == "true"
```

**State:** `PaymentProcess.waiting_for_email`

### 4. –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã

–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
- üíº **–ë–∞–ª–∞–Ω—Å** ‚Äî –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
- üí≥ **–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞** (YooKassa/–ÆMoney)
- üíé **–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞** (CryptoBot/Heleket)
- ü™ô **TON Connect**
- ‚≠ê **Telegram Stars**
- üè¶ **–°–ë–ü** —á–µ—Ä–µ–∑ Platega

**State:** `PaymentProcess.waiting_for_payment_method`

**–§–∞–π–ª:** [src/shop_bot/bot/keyboards.py](src/shop_bot/bot/keyboards.py#L977-L1045)

### 5. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–Ω–≤–æ–π—Å:

```python
# –ü—Ä–∏–º–µ—Ä: YooKassa
payment_id = str(uuid.uuid4())
metadata = {
    "user_id": user_id,
    "months": months,
    "duration_days": duration_days,
    "price": float(price),
    "action": "new",  # new | extend | trial | gift
    "key_id": None,
    "host_name": host_name,
    "plan_id": plan_id,
    "customer_email": customer_email,
    "payment_method": "YooKassa",
    "payment_id": payment_id,
}

# –°–æ–∑–¥–∞–Ω–∏–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
create_payload_pending(payment_id, user_id, float(price), metadata)
```

**–§–∞–π–ª:** [src/shop_bot/bot/handlers.py](src/shop_bot/bot/handlers.py#L1785-L1850)

### 6. Webhook –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook:

```python
# –ü—Ä–∏–º–µ—Ä: YooKassa webhook
@flask_app.route('/yookassa-webhook', methods=['POST'])
def yookassa_webhook_handler():
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞
    # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ payment_id –∏–∑ payload
    # 3. –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    metadata = find_and_complete_pending_transaction(payment_id)
    
    # 4. –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
    _dispatch_payment_processing(metadata)
```

**–§–∞–π–ª:** [src/shop_bot/webhook_server/app.py](src/shop_bot/webhook_server/app.py#L2663-L2775)

### 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

–§—É–Ω–∫—Ü–∏—è `process_successful_payment()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

```python
async def process_successful_payment(bot: Bot, metadata: dict):
    # 1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å - –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
    if not claim_processed_payment(payment_id):
        return  # –î—É–±–ª–∏–∫–∞—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    
    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ email –¥–ª—è –∫–ª—é—á–∞
    if action == "new":
        email = generate_key_email_for_user(user_id)  # 12345-1@bot.local
    elif action == "extend":
        email = existing_key['key_email']
    elif action == "gift":
        email = f"gift-{uuid4().hex[:8]}@bot.local"
    
    # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–∞—Ä–∏—Ñ–∞
    plan = get_plan_by_id(plan_id)
    months = plan.get('months')
    duration_days = plan.get('duration_days')
    traffic_limit_bytes = plan.get('traffic_limit_bytes')
    hwid_device_limit = plan.get('hwid_device_limit')
    
    days_to_add = duration_days if duration_days else months * 30
    
    # 4. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –Ω–∞ VPN-—Ö–æ—Å—Ç–µ —á–µ—Ä–µ–∑ Remnawave API
    result = await remnawave_api.create_or_update_key_on_host(
        host_name=host_name,
        email=email,
        days_to_add=days_to_add,
        traffic_limit_bytes=traffic_limit_bytes,
        hwid_device_limit=hwid_device_limit,
    )
    
    # 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞ –≤ –ë–î
    origin_desc = _build_key_origin_meta(
        source="purchase",
        plan_id=plan_id,
        plan_name=plan.get('plan_name'),
        months=months,
        duration_days=duration_days,
    )
    
    key_id = record_key_from_payload(
        user_id=user_id,
        payload=result,
        host_name=host_name,
        tag="paid",
        description=origin_desc,
    )
    
    # 6. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞
    # 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # 8. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
}
```

**–§–∞–π–ª:** [src/shop_bot/bot/handlers.py](src/shop_bot/bot/handlers.py#L6318-L6850)

### 8. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

–§—É–Ω–∫—Ü–∏—è `record_key_from_payload()` –ø–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç Remnawave –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:

```python
def record_key_from_payload(
    user_id: int,
    payload: dict,
    *,
    host_name: str | None = None,
    description: str | None = None,
    tag: str | None = None,
) -> int | None:
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ payload
    squad_uuid = payload.get('squad_uuid')
    remnawave_user_uuid = payload.get('client_uuid')
    email = payload.get('email')
    expire_at_ms = payload.get('expiry_timestamp_ms')
    subscription_url = payload.get('connection_string')
    
    # –í—ã–∑–æ–≤ record_key –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    return record_key(
        user_id=user_id,
        squad_uuid=squad_uuid,
        remnawave_user_uuid=remnawave_user_uuid,
        email=email,
        host_name=host_name,
        expire_at_ms=expire_at_ms,
        subscription_url=subscription_url,
        tag=tag,
        description=description,
    )
```

**–§–∞–π–ª:** [src/shop_bot/data_manager/remnawave_repository.py](src/shop_bot/data_manager/remnawave_repository.py#L187-L225)

### 9. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞:

```python
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
new_expiry_date = datetime.fromtimestamp(result['expiry_timestamp_ms'] / 1000)
connection_string = result['connection_string']

text = get_purchase_success_text(
    action="new",
    key_number=get_next_key_number(user_id) - 1,
    expiry_date=new_expiry_date,
    connection_string=connection_string
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
await bot.send_message(
    chat_id=user_id,
    text=text,
    reply_markup=keyboards.create_key_info_keyboard(key_id, connection_string)
)
```

---

## –°–≤—è–∑—å –∫–ª—é—á–µ–π —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏

### –ü—Ä—è–º–∞—è —Å–≤—è–∑—å

–ö–ª—é—á–∏ —Å–≤—è–∑–∞–Ω—ã —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ —á–µ—Ä–µ–∑:
1. **plan_id** –≤ metadata –ø–ª–∞—Ç–µ–∂–∞
2. **description** (JSON) –≤ —Ç–∞–±–ª–∏—Ü–µ vpn_keys
3. **–õ–∏–º–∏—Ç—ã** ‚Äî –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–∞

### –°—Ö–µ–º–∞ —Å–≤—è–∑–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    users     ‚îÇ
‚îÇ  telegram_id ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1
       ‚îÇ
       ‚îÇ N
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      vpn_keys            ‚îÇ   N    ‚îÇ   plans     ‚îÇ
‚îÇ                          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îÇ  key_id                  ‚îÇ   1    ‚îÇ  plan_id    ‚îÇ
‚îÇ  user_id (FK)            ‚îÇ        ‚îÇ  host_name  ‚îÇ
‚îÇ  host_name (FK)          ‚îÇ        ‚îÇ  plan_name  ‚îÇ
‚îÇ  email (UNIQUE)          ‚îÇ        ‚îÇ  months     ‚îÇ
‚îÇ  subscription_url        ‚îÇ        ‚îÇ  price      ‚îÇ
‚îÇ  expire_at               ‚îÇ        ‚îÇ  traffic_   ‚îÇ
‚îÇ  traffic_limit_bytes     ‚îÇ        ‚îÇ  limit_bytes‚îÇ
‚îÇ  hwid_device_limit       ‚îÇ        ‚îÇ  hwid_      ‚îÇ
‚îÇ  tag                     ‚îÇ        ‚îÇ  device_    ‚îÇ
‚îÇ  description (JSON):     ‚îÇ        ‚îÇ  limit      ‚îÇ
‚îÇ    {                     ‚îÇ        ‚îÇ  is_active  ‚îÇ
‚îÇ      "plan_id": 3,       ‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ      "plan_name": "..."  ‚îÇ
‚îÇ      "months": 1         ‚îÇ        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    }                     ‚îÇ   N    ‚îÇ  xui_hosts  ‚îÇ
‚îÇ                          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   1    ‚îÇ  host_name  ‚îÇ
                                     ‚îÇ  (PK)       ‚îÇ
                                     ‚îÇ  host_url   ‚îÇ
                                     ‚îÇ  squad_uuid ‚îÇ
                                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—á–µ–º—É –Ω–µ –ø—Ä—è–º–∞—è FK –∫ plans?

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é** —á–µ—Ä–µ–∑ JSON –≤ `description`:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. **–ò—Å—Ç–æ—Ä–∏—á–Ω–æ—Å—Ç—å** ‚Äî –µ—Å–ª–∏ —Ç–∞—Ä–∏—Ñ –∏–∑–º–µ–Ω–∏—Ç—Å—è, —Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
2. **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –∫–ª—é—á–∞
3. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** ‚Äî –∫–ª—é—á –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–∞

**–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ:**
```python
# 1. –ü–æ–ª—É—á–∞–µ–º —Ç–∞—Ä–∏—Ñ
plan = get_plan_by_id(plan_id)

# 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
months = plan.get('months')
price = plan.get('price')
traffic_limit = plan.get('traffic_limit_bytes')

# 3. –°–æ–∑–¥–∞–µ–º –∫–ª—é—á —Å —ç—Ç–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
result = create_key(
    email=email,
    days_to_add=months * 30,
    traffic_limit_bytes=traffic_limit,
)

# 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–∞—Ä–∏—Ñ –≤ description
description = json.dumps({
    "plan_id": plan_id,
    "plan_name": plan['plan_name'],
    "months": months,
    "price": price,
})
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞—Ä–∏—Ñ–µ –∫–ª—é—á–∞

```python
def _get_tariff_info_for_key(key_data: dict, user_payload: dict | None = None):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–∏—Ñ–µ –∏–∑ –∫–ª—é—á–∞."""
    
    # 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ description
    description = key_data.get('description', '')
    if description and description.startswith('{'):
        try:
            meta = json.loads(description)
            if meta.get('tariff_label'):
                return (
                    meta.get('plan_name'),
                    meta.get('tariff_label'),
                    meta.get('device_limit')
                )
        except:
            pass
    
    # 2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ plan_id
    plan_id = key_data.get('plan_id')
    if plan_id:
        plan = get_plan_by_id(plan_id)
        if plan:
            return (
                plan.get('plan_name'),
                f"{plan.get('months')} –º–µ—Å.",
                plan.get('hwid_device_limit')
            )
    
    # 3. Fallback ‚Äî –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    return ('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', '‚Äî', None)
```

**–§–∞–π–ª:** [src/shop_bot/bot/handlers.py](src/shop_bot/bot/handlers.py#L3440-L3530)

---

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–ª—é—á–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ (New)

```python
action = "new"
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π email: {user_id}-{key_number}@bot.local
# –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ + —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
# tag = "paid" (–∏–ª–∏ "trial" –¥–ª—è —Ç—Ä–∏–∞–ª—å–Ω—ã—Ö)
```

### 2. –ê–∫—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–∏–æ–¥

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á:
- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ VPN
- –†–∞—Å—Ö–æ–¥—É–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏–º–∏—Ç)
- –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç `expire_at`

### 3. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

–ó–∞ N –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è:
```python
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤:
notification_days = get_setting("expiry_notification_days") or "3,1"

# –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
await bot.send_message(
    user_id,
    f"‚è∞ –í–∞—à –∫–ª—é—á #{key_number} –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {days_left} –¥–Ω."
)
```

### 4. –ü—Ä–æ–¥–ª–µ–Ω–∏–µ (Extend)

```python
action = "extend"
key_id = existing_key['key_id']
# –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π email
# –°—Ä–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É (–µ—Å–ª–∏ –Ω–µ –∏—Å—Ç–µ–∫)
# tag –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ "paid"
```

**–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:**
```python
# –ï—Å–ª–∏ —Å—Ä–æ–∫ –µ—â–µ –Ω–µ –∏—Å—Ç–µ–∫ ‚Äî –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
exp_ms = existing_key['expire_at']
now_ms = int(time.time() * 1000)

if exp_ms > now_ms:
    # –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
    new_expiry = exp_ms + (days_to_add * 86400000)
else:
    # –ò—Å—Ç–µ–∫ ‚Äî –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
    new_expiry = now_ms + (days_to_add * 86400000)
```

### 5. –ò—Å—Ç–µ—á–µ–Ω–∏–µ

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–ª—é—á–µ–π
expired_keys = get_expired_keys()

for key in expired_keys:
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —É–¥–∞–ª–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–∞
    await remove_key_from_host(key)
    
    # –ü–æ–º–µ—Ç–∫–∞ –≤ –ë–î
    mark_key_as_missing(key['key_id'])
```

### 6. –£–¥–∞–ª–µ–Ω–∏–µ

–ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```python
# –£–¥–∞–ª–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–∞
await remnawave_api.delete_key_from_host(host_name, email)

# –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î (–∏–ª–∏ –ø–æ–º–µ—Ç–∫–∞)
delete_key_by_email(email)
```

---

## API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `generate_key_email_for_user()`
```python
def generate_key_email_for_user(user_id: int, *, domain: str = "bot.local") -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π email –¥–ª—è –∫–ª—é—á–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –§–æ—Ä–º–∞—Ç: {user_id}-{key_number}@{domain}
    –ù–∞–ø—Ä–∏–º–µ—Ä: 12345-1@bot.local, 12345-2@bot.local
    """
    next_number = get_next_key_number(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    for attempt in range(1000):
        candidate = f"{user_id}-{next_number}@{domain}"
        if not get_key_by_email(candidate):
            return candidate
        next_number += 1
    
    # Fallback –Ω–∞ timestamp
    return f"{user_id}-{int(time.time())}@{domain}"
```

**–§–∞–π–ª:** [src/shop_bot/data_manager/remnawave_repository.py](src/shop_bot/data_manager/remnawave_repository.py#L268-L291)

---

#### `record_key_from_payload()`
```python
def record_key_from_payload(
    user_id: int,
    payload: dict[str, Any],
    *,
    host_name: str | None = None,
    description: str | None = None,
    tag: str | None = None,
) -> int | None:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–ª—é—á –∏–∑ –æ—Ç–≤–µ—Ç–∞ Remnawave API –≤ –ë–î.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
        payload: –û—Ç–≤–µ—Ç –æ—Ç Remnawave API —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞
        host_name: –ò–º—è —Ö–æ—Å—Ç–∞
        description: JSON —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ —Ç–∞—Ä–∏—Ñ–∞
        tag: –¢–µ–≥ –∫–ª—é—á–∞ (paid, trial, user_gift)
    
    Returns:
        key_id –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    # –ü–∞—Ä—Å–∏–Ω–≥ payload
    squad_uuid = payload.get('squad_uuid')
    remnawave_user_uuid = payload.get('client_uuid')
    email = payload.get('email')
    expire_at_ms = payload.get('expiry_timestamp_ms')
    subscription_url = payload.get('connection_string')
    
    # –í—ã–∑–æ–≤ record_key
    return record_key(
        user_id=user_id,
        squad_uuid=squad_uuid,
        remnawave_user_uuid=remnawave_user_uuid,
        email=email,
        host_name=host_name,
        expire_at_ms=expire_at_ms,
        subscription_url=subscription_url,
        tag=tag,
        description=description,
    )
```

---

#### `record_key()`
```python
def record_key(
    user_id: int,
    squad_uuid: str,
    remnawave_user_uuid: str,
    email: str,
    *,
    host_name: str | None = None,
    expire_at_ms: int | None = None,
    subscription_url: str | None = None,
    traffic_limit_bytes: int | None = None,
    traffic_limit_strategy: str | None = None,
    tag: str | None = None,
    description: str | None = None,
) -> int | None:
    """–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª—é—á –≤ –ë–î.
    
    –õ–æ–≥–∏–∫–∞:
    1. –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞ –ø–æ email –∏–ª–∏ remnawave_user_uuid
    2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
    
    Returns:
        key_id —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–ª–∏ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞
    """
    email_normalized = _normalize_email(email)
    
    # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
    existing = None
    if email_normalized:
        existing = get_key_by_email(email_normalized)
    if not existing and remnawave_user_uuid:
        existing = get_key_by_remnawave_uuid(remnawave_user_uuid)
    
    if existing:
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        update_key_fields(
            existing['key_id'],
            expire_at_ms=expire_at_ms,
            subscription_url=subscription_url,
            traffic_limit_bytes=traffic_limit_bytes,
            tag=tag,
            description=description,
        )
        return existing['key_id']
    else:
        # –°–æ–∑–¥–∞–Ω–∏–µ
        return add_new_key(
            user_id=user_id,
            host_name=host_name,
            remnawave_user_uuid=remnawave_user_uuid,
            key_email=email_normalized,
            expiry_timestamp_ms=expire_at_ms,
            subscription_url=subscription_url,
            traffic_limit_bytes=traffic_limit_bytes,
            description=description,
            tag=tag,
        )
```

**–§–∞–π–ª:** [src/shop_bot/data_manager/remnawave_repository.py](src/shop_bot/data_manager/remnawave_repository.py#L124-L186)

---

#### `get_user_keys()`
```python
def get_user_keys(user_id: int) -> list[dict] | None:
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Returns:
        –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–µ–π, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
    """
    try:
        with sqlite3.connect(DB_FILE) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute(
                "SELECT * FROM vpn_keys WHERE user_id = ? "
                "ORDER BY datetime(created_at) DESC, key_id DESC",
                (user_id,)
            )
            rows = cursor.fetchall()
            return [_normalize_key_row(row) for row in rows]
    except Exception:
        return None
```

**–§–∞–π–ª:** [src/shop_bot/data_manager/database.py](src/shop_bot/data_manager/database.py#L3832-L3844)

---

#### `get_key_by_id()`
```python
def get_key_by_id(key_id: int) -> dict | None:
    """–ü–æ–ª—É—á–∞–µ—Ç –∫–ª—é—á –ø–æ ID."""
    try:
        with sqlite3.connect(DB_FILE) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM vpn_keys WHERE key_id = ?", (key_id,))
            row = cursor.fetchone()
            return _normalize_key_row(row)
    except Exception:
        return None
```

---

#### `update_key_fields()`
```python
def update_key_fields(
    key_id: int,
    *,
    user_id: int | None = None,
    host_name: str | None = None,
    remnawave_user_uuid: str | None = None,
    email: str | None = None,
    subscription_url: str | None = None,
    expire_at_ms: int | None = None,
    traffic_limit_bytes: int | None = None,
    traffic_limit_strategy: str | None = None,
    tag: str | None = None,
    description: str | None = None,
) -> bool:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –∫–ª—é—á–∞.
    
    –¢–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
    
    Returns:
        True –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
    """
    updates = {}
    if user_id is not None:
        updates["user_id"] = user_id
    if host_name is not None:
        updates["host_name"] = normalize_host_name(host_name)
    if email is not None:
        normalized = _normalize_email(email)
        updates["email"] = normalized
        updates["key_email"] = normalized
    if expire_at_ms is not None:
        updates["expire_at"] = _to_datetime_str(expire_at_ms)
    if traffic_limit_bytes is not None:
        updates["traffic_limit_bytes"] = traffic_limit_bytes
    if tag is not None:
        updates["tag"] = tag
    if description is not None:
        updates["description"] = description
    
    return _apply_key_updates(key_id, updates)
```

**–§–∞–π–ª:** [src/shop_bot/data_manager/database.py](src/shop_bot/data_manager/database.py#L3757-L3825)

---

#### `delete_key_by_email()`
```python
def delete_key_by_email(email: str) -> bool:
    """–£–¥–∞–ª—è–µ—Ç –∫–ª—é—á –∏–∑ –ë–î –ø–æ email."""
    try:
        email_normalized = _normalize_email(email)
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            cursor.execute(
                "DELETE FROM vpn_keys WHERE email = ? OR key_email = ?",
                (email_normalized, email_normalized)
            )
            conn.commit()
            return cursor.rowcount > 0
    except Exception:
        return False
```

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Remnawave API

#### `create_or_update_key_on_host()`
```python
async def create_or_update_key_on_host(
    host_name: str,
    email: str,
    *,
    days_to_add: int | None = None,
    expiry_timestamp_ms: int | None = None,
    traffic_limit_bytes: int | None = None,
    traffic_limit_strategy: str | None = None,
    hwid_device_limit: int | None = None,
    description: str | None = None,
    raise_on_error: bool = False,
) -> dict | None:
    """–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª—é—á –Ω–∞ VPN-—Ö–æ—Å—Ç–µ —á–µ—Ä–µ–∑ Remnawave API.
    
    Args:
        host_name: –ò–º—è —Ö–æ—Å—Ç–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã xui_hosts
        email: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π email –∫–ª—é—á–∞
        days_to_add: –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ–±–∞–≤–∏—Ç—å (–¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è)
        expiry_timestamp_ms: –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è
        traffic_limit_bytes: –õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (0 = –±–µ–∑–ª–∏–º–∏—Ç)
        hwid_device_limit: –õ–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (0 = –±–µ–∑–ª–∏–º–∏—Ç)
    
    Returns:
        dict —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞:
        {
            "client_uuid": "...",
            "email": "...",
            "expiry_timestamp_ms": 1234567890,
            "connection_string": "vless://...",
            "traffic_limit_bytes": 0,
            "short_uuid": "..."
        }
    """
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ö–æ—Å—Ç–∞
    host = get_host_by_name(host_name)
    if not host:
        raise ValueError(f"Host {host_name} not found")
    
    base_url = host.get('remnawave_base_url')
    api_token = host.get('remnawave_api_token')
    squad_uuid = host.get('squad_uuid')
    
    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    payload = {
        "email": email,
        "squadUuid": squad_uuid,
    }
    
    if days_to_add is not None:
        payload["daysToAdd"] = days_to_add
    if expiry_timestamp_ms is not None:
        payload["expiryTimestampMs"] = expiry_timestamp_ms
    if traffic_limit_bytes is not None:
        payload["trafficLimitBytes"] = traffic_limit_bytes
    if hwid_device_limit is not None:
        payload["hwidDeviceLimit"] = hwid_device_limit
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    async with aiohttp.ClientSession() as session:
        async with session.post(
            f"{base_url}/api/users",
            json=payload,
            headers={"Authorization": f"Bearer {api_token}"}
        ) as response:
            if response.status != 200:
                error_text = await response.text()
                if raise_on_error:
                    raise Exception(f"Remnawave API error: {error_text}")
                return None
            
            return await response.json()
```

**–§–∞–π–ª:** [src/shop_bot/modules/remnawave_api.py](src/shop_bot/modules/remnawave_api.py#L760-L920)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Telegram Bot (aiogram)             ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ       User Handlers                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –í—ã–±–æ—Ä —Ö–æ—Å—Ç–∞                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞                       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –û–ø–ª–∞—Ç–∞                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏                 ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Payment Processing                   ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   YooKassa     ‚îÇ  ‚îÇ   CryptoBot      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   –ÆMoney       ‚îÇ  ‚îÇ   Heleket        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Platega      ‚îÇ  ‚îÇ   TON Connect    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Stars        ‚îÇ  ‚îÇ   Balance        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ                  ‚îÇ
            ‚îÇ  Webhooks        ‚îÇ
            ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Webhook Handlers (Flask)            ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  _dispatch_payment_processing()        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å                     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞                    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  - –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏                    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     process_successful_payment()              ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è email                         ‚îÇ
‚îÇ  2. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–∞—Ä–∏—Ñ–∞             ‚îÇ
‚îÇ  3. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –Ω–∞ —Ö–æ—Å—Ç–µ                 ‚îÇ
‚îÇ  4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î                         ‚îÇ
‚îÇ  5. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞                     ‚îÇ
‚îÇ  6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚ñº         ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Remnawave  ‚îÇ ‚îÇ   SQLite ‚îÇ ‚îÇ   Telegram    ‚îÇ
‚îÇ    API     ‚îÇ ‚îÇ    DB    ‚îÇ ‚îÇ  Notifications‚îÇ
‚îÇ            ‚îÇ ‚îÇ          ‚îÇ ‚îÇ               ‚îÇ
‚îÇ POST /api  ‚îÇ ‚îÇ vpn_keys ‚îÇ ‚îÇ send_message()‚îÇ
‚îÇ   /users   ‚îÇ ‚îÇ  plans   ‚îÇ ‚îÇ               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ

```
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]
    ‚îÇ
    ‚îÇ 1. –í—ã–±–æ—Ä —Ö–æ—Å—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ–∞
    ‚ñº
[Bot Handlers]
    ‚îÇ
    ‚îÇ 2. –°–æ–∑–¥–∞–Ω–∏–µ metadata + payment_id
    ‚ñº
[Payment Provider]
    ‚îÇ create_invoice()
    ‚îÇ
    ‚îÇ 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
    ‚ñº
[Webhook]
    ‚îÇ payment_id + status=paid
    ‚îÇ
    ‚îÇ 4. find_and_complete_pending_transaction()
    ‚ñº
[_dispatch_payment_processing]
    ‚îÇ asyncio task
    ‚îÇ
    ‚îÇ 5. –ó–∞–ø—É—Å–∫ –≤ event loop –∏–ª–∏ thread
    ‚ñº
[process_successful_payment]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 6a. Remnawave API
    ‚îÇ        create_or_update_key_on_host()
    ‚îÇ        ‚Üì
    ‚îÇ        {client_uuid, email, expiry_ms, connection_string}
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 6b. Database
    ‚îÇ        record_key_from_payload()
    ‚îÇ        ‚Üì
    ‚îÇ        INSERT INTO vpn_keys (...)
    ‚îÇ        ‚Üì
    ‚îÇ        key_id
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 6c. Referral System
    ‚îÇ        add_to_balance(referrer_id, reward)
    ‚îÇ
    ‚îî‚îÄ‚ñ∫ 6d. Notification
         bot.send_message(user_id, success_text)
         ‚Üì
    [–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –∫–ª—é—á]
```

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö webhooks:

```python
# 1. Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
payment_id = str(uuid.uuid4())
metadata = {...}
create_payload_pending(payment_id, user_id, price, metadata)

# 2. –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (–æ–¥–∏–Ω —Ä–∞–∑)
def find_and_complete_pending_transaction(payment_id: str) -> dict | None:
    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        # –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        cursor.execute(
            "UPDATE pending_payments SET status = 'paid' "
            "WHERE payment_id = ? AND status = 'pending'",
            (payment_id,)
        )
        if cursor.rowcount == 0:
            return None  # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        cursor.execute(
            "SELECT metadata FROM pending_payments WHERE payment_id = ?",
            (payment_id,)
        )
        row = cursor.fetchone()
        return json.loads(row[0]) if row else None

# 3. Processed payments (–≤—Ç–æ—Ä–∞—è –ª–∏–Ω–∏—è –∑–∞—â–∏—Ç—ã)
def claim_processed_payment(payment_id: str) -> bool:
    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        try:
            cursor.execute(
                "INSERT INTO processed_payments (payment_id, processed_at) "
                "VALUES (?, CURRENT_TIMESTAMP)",
                (payment_id,)
            )
            conn.commit()
            return True
        except sqlite3.IntegrityError:
            return False  # –î—É–±–ª–∏–∫–∞—Ç
```

**–§–∞–π–ª:** [src/shop_bot/webhook_server/app.py](src/shop_bot/webhook_server/app.py#L87-L135)

### –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

```python
def _dispatch_payment_processing(metadata: dict) -> None:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ."""
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π event loop –±–æ—Ç–∞
    loop = current_app.config.get('EVENT_LOOP')
    bot = _bot_controller.get_bot_instance()
    
    if bot and loop and loop.is_running():
        # –ó–∞–ø—É—Å–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º event loop
        asyncio.run_coroutine_threadsafe(
            process_successful_payment(bot, metadata),
            loop
        )
        return
    
    # Fallback: —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π event loop –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    def _worker():
        async def _run():
            bot = Bot(token=telegram_bot_token)
            try:
                await process_successful_payment(bot, metadata)
            finally:
                await bot.close()
        
        asyncio.run(_run())
    
    threading.Thread(
        target=_worker,
        name="payment-fulfillment",
        daemon=True
    ).start()
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ (–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ)

```python
import asyncio
from src.shop_bot.modules import remnawave_api
from src.shop_bot.data_manager import remnawave_repository as rw_repo

async def create_key_for_user(user_id: int, host_name: str, plan_id: int):
    # 1. –ü–æ–ª—É—á–∞–µ–º —Ç–∞—Ä–∏—Ñ
    from src.shop_bot.data_manager.database import get_plan_by_id
    plan = get_plan_by_id(plan_id)
    
    # 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º email
    email = rw_repo.generate_key_email_for_user(user_id)
    print(f"Generated email: {email}")
    
    # 3. –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –Ω–∞ —Ö–æ—Å—Ç–µ
    result = await remnawave_api.create_or_update_key_on_host(
        host_name=host_name,
        email=email,
        days_to_add=plan['months'] * 30,
        traffic_limit_bytes=plan.get('traffic_limit_bytes'),
        hwid_device_limit=plan.get('hwid_device_limit'),
    )
    
    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    key_id = rw_repo.record_key_from_payload(
        user_id=user_id,
        payload=result,
        host_name=host_name,
        tag="paid",
        description=json.dumps({
            "plan_id": plan_id,
            "plan_name": plan['plan_name'],
            "months": plan['months'],
        })
    )
    
    print(f"Key created: {key_id}")
    print(f"Connection string: {result['connection_string']}")
    
    return key_id

# –ó–∞–ø—É—Å–∫
asyncio.run(create_key_for_user(
    user_id=12345,
    host_name="vpn_main",
    plan_id=3
))
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
from src.shop_bot.data_manager.database import get_user_keys

user_id = 12345
keys = get_user_keys(user_id)

for key in keys:
    print(f"""
    –ö–ª—é—á #{key['key_id']}
    ‚îú‚îÄ Email: {key['key_email']}
    ‚îú‚îÄ –•–æ—Å—Ç: {key['host_name']}
    ‚îú‚îÄ –ò—Å—Ç–µ–∫–∞–µ—Ç: {key['expire_at']}
    ‚îú‚îÄ –¢—Ä–∞—Ñ–∏–∫: {key.get('traffic_limit_bytes', '–ë–µ–∑–ª–∏–º–∏—Ç')}
    ‚îî‚îÄ –¢–µ–≥: {key.get('tag', '‚Äî')}
    """)
```

### –ü—Ä–∏–º–µ—Ä 3: –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–ª—é—á–∞

```python
async def extend_key(key_id: int, days: int):
    # 1. –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á
    from src.shop_bot.data_manager.database import get_key_by_id
    key = get_key_by_id(key_id)
    
    # 2. –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –Ω–∞ —Ö–æ—Å—Ç–µ
    result = await remnawave_api.create_or_update_key_on_host(
        host_name=key['host_name'],
        email=key['key_email'],
        days_to_add=days,
    )
    
    # 3. –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ë–î
    from src.shop_bot.data_manager import remnawave_repository as rw_repo
    rw_repo.update_key(
        key_id,
        expire_at_ms=result['expiry_timestamp_ms'],
        description=json.dumps({
            "source": "extend",
            "extended_days": days,
        })
    )
    
    print(f"Key {key_id} extended by {days} days")
    print(f"New expiry: {result['expiry_timestamp_ms']}")

asyncio.run(extend_key(key_id=42, days=30))
```

### –ü—Ä–∏–º–µ—Ä 4: –¢—Ä–∏–∞–ª—å–Ω—ã–π –∫–ª—é—á

```python
async def create_trial_key(user_id: int, host_name: str):
    from src.shop_bot.data_manager.database import get_setting
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–∏–∞–ª–∞
    trial_days = int(get_setting("trial_duration_days") or 3)
    trial_traffic_gb = int(get_setting("trial_traffic_limit_gb") or 10)
    traffic_bytes = trial_traffic_gb * 1024**3
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º email
    email = rw_repo.generate_key_email_for_user(user_id)
    
    # –°–æ–∑–¥–∞–µ–º
    result = await remnawave_api.create_or_update_key_on_host(
        host_name=host_name,
        email=email,
        days_to_add=trial_days,
        traffic_limit_bytes=traffic_bytes,
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å —Ç–µ–≥–æ–º trial
    key_id = rw_repo.record_key_from_payload(
        user_id=user_id,
        payload=result,
        host_name=host_name,
        tag="trial",
        description=json.dumps({
            "source": "trial",
            "is_trial": True,
            "duration_days": trial_days,
        })
    )
    
    return key_id, result['connection_string']
```

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –¥–∞–Ω–Ω—ã—Ö: —Ç–∞–±–ª–∏—Ü—ã –ë–î

```sql
-- –°—Ö–µ–º–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
users (telegram_id, username, balance, referral_balance, referred_by)
  ‚îÇ
  ‚îú‚îÄ‚ñ∫ vpn_keys (user_id FK ‚Üí users.telegram_id)
  ‚îÇ     ‚îú‚îÄ host_name FK ‚Üí xui_hosts.host_name
  ‚îÇ     ‚îî‚îÄ description (JSON) ‚Üí plan_id ‚Üí plans.plan_id
  ‚îÇ
  ‚îú‚îÄ‚ñ∫ transactions (user_id FK ‚Üí users.telegram_id)
  ‚îÇ
  ‚îî‚îÄ‚ñ∫ user_gifts (from_user_id FK ‚Üí users.telegram_id)
        ‚îî‚îÄ key_id FK ‚Üí vpn_keys.key_id

-- –•–æ—Å—Ç—ã –∏ —Ç–∞—Ä–∏—Ñ—ã
xui_hosts (host_name PK, squad_uuid, host_url, remnawave_base_url)
  ‚îÇ
  ‚îî‚îÄ‚ñ∫ plans (host_name FK ‚Üí xui_hosts.host_name)
        ‚îî‚îÄ plan_id PK
           ‚îú‚îÄ plan_name, months, price
           ‚îú‚îÄ traffic_limit_bytes
           ‚îî‚îÄ hwid_device_limit

-- –ü–ª–∞—Ç–µ–∂–∏
pending_payments (payment_id PK, user_id, status, metadata JSON)
processed_payments (payment_id PK, processed_at)
transactions (transaction_id PK, user_id FK, payment_id, status, amount_rub)
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–ª—é—á –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª, –Ω–æ –∫–ª—é—á –Ω–µ –ø—Ä–∏—à–µ–ª
- –û—à–∏–±–∫–∞ "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á"

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
grep "Key creation error" logs/bot.log
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞:
```python
from src.shop_bot.modules.remnawave_api import check_host_connection
result = await check_host_connection("vpn_main")
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
```sql
SELECT * FROM pending_payments WHERE payment_id = '...';
```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ processed_payments (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å):
```sql
SELECT * FROM processed_payments WHERE payment_id = '...';
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –¥–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–ª—é—á–∞
- Email collision error

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å email:
```sql
SELECT COUNT(*), key_email FROM vpn_keys GROUP BY key_email HAVING COUNT(*) > 1;
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
```sql
SELECT COUNT(*), payment_id FROM pending_payments GROUP BY payment_id HAVING COUNT(*) > 1;
```

3. –û—á–∏—Å—Ç–∏—Ç–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!):
```python
# –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—Å—Ç–∞–≤–∏–≤ —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π
duplicates = """
SELECT key_id FROM vpn_keys 
WHERE key_email IN (
    SELECT key_email FROM vpn_keys 
    GROUP BY key_email HAVING COUNT(*) > 1
)
AND key_id NOT IN (
    SELECT MAX(key_id) FROM vpn_keys 
    GROUP BY key_email
)
"""
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–ª—é—á –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª, –Ω–æ —Å—Ä–æ–∫ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ"

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á:
```python
key = get_key_by_id(key_id)
print(f"Current expiry: {key['expire_at']}")
print(f"Email: {key['key_email']}")
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç Remnawave:
```python
result = await remnawave_api.create_or_update_key_on_host(
    host_name=key['host_name'],
    email=key['key_email'],
    days_to_add=30
)
print(f"New expiry from API: {result['expiry_timestamp_ms']}")
```

3. –û–±–Ω–æ–≤–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:
```python
from src.shop_bot.data_manager import remnawave_repository as rw_repo
rw_repo.update_key(
    key_id,
    expire_at_ms=result['expiry_timestamp_ms']
)
```

---

## –°–º. —Ç–∞–∫–∂–µ

- [TARIFFS_GUIDE.md](TARIFFS_GUIDE.md) ‚Äî –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ç–∞—Ä–∏—Ñ–æ–≤
- [FRANCHISE_IMPLEMENTATION.MD](FRANCHISE_IMPLEMENTATION.md) ‚Äî –§—Ä–∞–Ω—à–∏–∑–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–æ–Ω–∞–º–∏
- [README.md](README.md) ‚Äî –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
- –§–∞–π–ª—ã:
  - `src/shop_bot/data_manager/database.py` ‚Äî –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î
  - `src/shop_bot/data_manager/remnawave_repository.py` ‚Äî –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–ª—é—á–µ–π
  - `src/shop_bot/modules/remnawave_api.py` ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Remnawave
  - `src/shop_bot/bot/handlers.py` ‚Äî –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞
  - `src/shop_bot/webhook_server/app.py` ‚Äî Webhook-—Å–µ—Ä–≤–µ—Ä

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 13 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–í–µ—Ä—Å–∏—è:** 1.0
