# –ú–æ–¥—É–ª–∏ (Plugins) –¥–ª—è Xatabchik

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–æ–¥—É–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º –º–æ–¥—É–ª—è–º.

## –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–Ω–µ–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–¥—Ä–∞. –ú–æ–¥—É–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `modules/` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –º–æ–≥—É—Ç –≤–∫–ª—é—á–∞—Ç—å—Å—è/–≤—ã–∫–ª—é—á–∞—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –∏–ª–∏ Telegram-–∞–¥–º–∏–Ω–∫—É.

–ö–ª—é—á–µ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞:
- –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫: —Å–±–æ–∏ –º–æ–¥—É–ª–µ–π –Ω–µ –ø–∞–¥–∞—é—Ç –Ω–∞ —è–¥—Ä–æ.
- –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–æ–¥—É–ª—è.
- –ì–æ—Ä—è—á–µ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏.

## –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π

–ú–æ–¥—É–ª–∏ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤ –≤–∏–¥–µ ZIP –∞—Ä—Ö–∏–≤–æ–≤ –ø—Ä—è–º–æ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –≤–µ–±-–ø–∞–Ω–µ–ª—å

1. –í–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (`https://–≤–∞—à-–¥–æ–º–µ–Ω/`)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **üß© –ú–æ–¥—É–ª–∏**
3. –í –ø–æ–ª–µ **üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å** –≤—ã–±–µ—Ä–∏—Ç–µ ZIP –∞—Ä—Ö–∏–≤
4. –ù–∞–∂–º–∏—Ç–µ **–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å**

ZIP –∞—Ä—Ö–∏–≤ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–æ–¥—É–ª—å —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
```
my_module.zip
  my_module/
    __init__.py
    bot_handlers.py
    ...
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ**: ZIP –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –º–æ–¥—É–ª—è, –∞ –Ω–µ —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é.

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Telegram-–∞–¥–º–∏–Ω–∫—É

```
/admin ‚Üí –ú–æ–¥—É–ª–∏ ‚Üí –≤—ã–±—Ä–∞—Ç—å –º–æ–¥—É–ª—å ‚Üí –í–∫–ª—é—á–∏—Ç—å
```

### –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ

```python
from shop_bot.core.module_loader import get_global_module_loader

loader = get_global_module_loader()
ok, message = loader.import_module_from_zip(
    "/path/to/module.zip",
    auto_enable=True  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å
)
print(message)
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ZIP

- ‚úÖ –ë–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫
- ‚úÖ –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å ‚Äî —ç—Ç–æ –ø–∞–ø–∫–∞ –≤ `modules/`:

```
modules/
  my_module/
    __init__.py
    bot_handlers.py
    panel_routes.py
    db_schema.py
    db_cleanup.py
    settings_schema.py
```

–û–±—è–∑–∞—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ `__init__.py`. –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã.

## –ú–∞–Ω–∏—Ñ–µ—Å—Ç –º–æ–¥—É–ª—è (`__init__.py`)

–ú–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `MODULE_META` —Ç–∏–ø–∞ `ModuleMeta`.

–ü—Ä–∏–º–µ—Ä:

```python
from shop_bot.core.module_types import ModuleMeta

MODULE_META = ModuleMeta(
    id="my_module",
    name="My Module",
    version="1.0.0",
    description="Module description",
    author="Author",
    requires=["other_module"],
    bot_entry="bot_handlers",
    panel_entry="panel_routes",
    db_schema="db_schema",
    db_cleanup="db_cleanup",
    settings_schema="settings_schema",
    menu_items=[
        {"label": "My Module", "url": "/modules/my_module/", "icon": "plug"}
    ],
)
```

### –ü–æ–ª—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞

- `id`: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–æ–¥—É–ª—è. –î–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–∞–ø–∫–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å regex `[a-z0-9_]+`.
- `name`: —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.
- `version`: –≤–µ—Ä—Å–∏—è (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è).
- `description`: –æ–ø–∏—Å–∞–Ω–∏–µ.
- `author`: –∞–≤—Ç–æ—Ä –º–æ–¥—É–ª—è.
- `requires`: —Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (id –º–æ–¥—É–ª–µ–π).
- `bot_entry`: –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .py), –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω `router`.
- `panel_entry`: –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .py), –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω `bp`.
- `db_schema`: –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .py), –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω `SCHEMA_SQL`.
- `db_cleanup`: –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .py), –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω `cleanup(db_conn)`.
- `settings_schema`: –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ .py), –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω `SETTINGS`.
- `menu_items`: –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é –ø–∞–Ω–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–∞–π–¥–±–∞—Ä–µ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –º–æ–¥—É–ª–µ.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º (aiogram)

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `bot_entry`, –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `router: aiogram.Router`.

```python
from aiogram import Router, F, types

router = Router()

@router.callback_query(F.data == "mod:my_module:ping")
async def handle_ping(callback: types.CallbackQuery) -> None:
    await callback.answer("pong")
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å callback_data

–ß—Ç–æ–±—ã –º–æ–¥—É–ª—å –Ω–µ –º–æ–≥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —è–¥—Ä–∞, callback_data –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –æ–¥–Ω–æ–≥–æ –∏–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤:
- `mod:<module_id>:`
- `<module_id>:`

–ü—Ä–∏–º–µ—Ä –¥–ª—è –º–æ–¥—É–ª—è `my_module`:
- `mod:my_module:ping`
- `my_module:action`

–ï—Å–ª–∏ callback_data –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å—É –º–æ–¥—É–ª—è, middleware –µ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–∞–Ω–µ–ª—å—é (Flask)

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `panel_entry`, –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `bp: flask.Blueprint`.

```python
from flask import Blueprint, render_template

bp = Blueprint(
    "my_module",
    __name__,
    url_prefix="/modules/my_module",
    template_folder="templates",
)

@bp.route("/")
def index():
    return render_template("modules/my_module/index.html")
```

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—Ä–µ—Ñ–∏–∫—Å URL: `/modules/<module_id>/`.

## –°—Ö–µ–º–∞ –ë–î –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `db_schema`, –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `SCHEMA_SQL` (—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —Å–ø–∏—Å–æ–∫ SQL-–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤).

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å `<module_id>_`.

```python
SCHEMA_SQL = """
CREATE TABLE IF NOT EXISTS my_module_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL
);
"""
```

### –û—á–∏—Å—Ç–∫–∞

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `db_cleanup`, –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `cleanup(db_conn)`.

```python
def cleanup(db_conn):
    cursor = db_conn.cursor()
    cursor.execute("DROP TABLE IF EXISTS my_module_items")
    cursor.execute("DELETE FROM bot_settings WHERE key LIKE 'my_module_%'")
    db_conn.commit()
```

–ï—Å–ª–∏ `db_cleanup` –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–æ–¥—É–ª—è —è–¥—Ä–æ —É–¥–∞–ª–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `<module_id>_`. –¢–∞–±–ª–∏—Ü—ã –º–æ–¥—É–ª—è –¥–æ–ª–∂–Ω—ã —É–¥–∞–ª—è—Ç—å—Å—è —è–≤–Ω–æ –≤ `cleanup`.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è

–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω `settings_schema`, –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `SETTINGS`:

```python
SETTINGS = [
    {"key": "api_url", "label": "API URL", "type": "text", "default": ""},
    {"key": "enabled", "label": "Enable", "type": "boolean", "default": False},
    {"key": "max_count", "label": "Max", "type": "number", "default": 10},
]
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `bot_settings` —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `<module_id>_`.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã:
- `text`
- `number`
- `boolean`

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –º–æ–¥—É–ª—è

- **Discover**: –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –º–æ–¥—É–ª–∏ —Å–∫–∞–Ω–∏—Ä—É—é—Ç—Å—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –≤ `modules_registry`.
- **Enable**: –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å—Ö–µ–º–∞ –ë–î, —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è Router –∏ Blueprint.
- **Disable**: Router –∏ Blueprint –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è.
- **Delete**: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `cleanup`, —É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —É–¥–∞–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –∏–∑ `modules_registry`, —É–¥–∞–ª—è–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–æ–¥—É–ª—è.

–í–∞–∂–Ω–æ: —É–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ –ø–∞–ø–∫—É –Ω–∞ –¥–∏—Å–∫–µ.

## –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫

- –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª–µ–π –≤–Ω—É—Ç—Ä–∏ `try/except`.
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –º–æ–¥—É–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `error`.
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ª–æ–≤—è—Ç—Å—è middleware –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–ï—Å–ª–∏ –º–æ–¥—É–ª—å –æ–±—ä—è–≤–ª—è–µ—Ç `requires`, –µ–≥–æ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥–∏–µ, –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è.

## –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- Callback-–¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –º–æ–¥—É–ª—è.
- –¢–∞–±–ª–∏—Ü—ã –ë–î –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `<module_id>_`.
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.

## –®–∞–±–ª–æ–Ω –º–æ–¥—É–ª—è

–ì–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `modules/example_module/` (–±–æ—Ç, –ø–∞–Ω–µ–ª—å, —Å—Ö–µ–º–∞, –æ—á–∏—Å—Ç–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏).
